{% extends "base.html" %} 

{% block title %}Riwayat Peminjaman{% endblock %}

{% block content %}
<div class="container my-5 pb-5 animate__animated animate__fadeIn">
 <div class="container my-5 pt-4">
    <div class="row mb-5 align-items-end g-4">
        <div class="col-lg-6">
            <div class="d-flex align-items-center gap-3 mb-2">
                <div class="bg-success rounded-pill" style="width: 40px; height: 4px;"></div>
                <h6 class="text-success fw-bold text-uppercase tracking-widest mb-0" style="font-size: 12px;">Pusat Aktivitas</h6>
            </div>
            <h2 class="fw-black text-dark display-5 mb-0" style="letter-spacing: -2px;">Pinjaman Saya</h2>
        </div>
        
        <div class="col-lg-6">
            <div class="d-flex flex-wrap justify-content-lg-end gap-2">
                {% with current_status=request.GET.status %}
                <a href="?{% for key, value in request.GET.items %}{% if key != 'status' and key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" 
                   class="filter-pill {% if not current_status %}active{% endif %}">
                    Semua
                </a>
                <a href="?{% for key, value in request.GET.items %}{% if key != 'status' and key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}status=pending" 
                   class="filter-pill {% if current_status == 'pending' %}active{% endif %}">
                    Menunggu
                </a>
                <a href="?{% for key, value in request.GET.items %}{% if key != 'status' and key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}status=approved" 
                   class="filter-pill {% if current_status == 'approved' %}active{% endif %}">
                    Dipinjam
                </a>
                <a href="?{% for key, value in request.GET.items %}{% if key != 'status' and key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}status=returned" 
                   class="filter-pill {% if current_status == 'returned' %}active{% endif %}">
                    Selesai
                </a>
                {% endwith %}
            </div>
        </div>
    </div>

    </div>

    {% if loans %}
    <div class="loan-container">
        <div class="row px-4 mb-3 d-none d-lg-flex text-muted small fw-black tracking-wider">
            <div class="col-lg-4">INFORMASI BUKU</div>
            <div class="col-lg-2 text-center">TGL PINJAM</div>
            <div class="col-lg-2 text-center">JATUH TEMPO</div>
            <div class="col-lg-2 text-center">STATUS & DENDA</div>
            <div class="col-lg-2 text-end">TINDAKAN</div>
        </div>

        {% for pinjam in loans %}
        <div class="loan-row-card mb-3 p-4">
            <div class="row align-items-center">
                
                <div class="col-lg-4 mb-3 mb-lg-0">
                    <div class="d-flex align-items-center">
                        <div class="index-number me-3">{{ forloop.counter }}</div>
                        <div>
                            <h5 class="fw-bold mb-1">
                                <a href="{% url 'detail_book' pk=pinjam.book.pk %}" class="text-dark text-decoration-none book-title-link">
                                    {{ pinjam.book.title }}
                                </a>
                            </h5>
                            <code class="text-success small fw-bold">ID-{{ pinjam.pk|stringformat:"04d" }}</code>
                        </div>
                    </div>
                </div>

                <div class="col-6 col-lg-2 text-lg-center">
                    <label class="d-lg-none d-block small text-muted fw-bold mb-1">DIPINJAM</label>
                    <span class="text-dark fw-medium">{{ pinjam.borrow_date|date:"d M Y" }}</span>
                </div>

                <div class="col-6 col-lg-2 text-lg-center">
                    <label class="d-lg-none d-block small text-muted fw-bold mb-1">TEMPO</label>
                    <span class="fw-bold {% if pinjam.current_fine > 0 %}text-danger{% else %}text-dark{% endif %}">
                        {{ pinjam.due_date|date:"d M Y" }}
                    </span>
                </div>

                <div class="col-12 col-lg-2 text-lg-center my-3 my-lg-0 border-lg-start border-lg-end">
                    <div class="d-flex flex-row flex-lg-column justify-content-between align-items-center gap-2">
                        {% if pinjam.status == 'pending' %}
                            <span class="badge-custom badge-pending">Menunggu</span>
                        {% elif pinjam.status == 'rejected' %}
                            <span class="badge-custom badge-rejected">Ditolak</span>
                        {% else %}
                            <span class="badge-custom badge-active">Dipinjam</span>
                        {% endif %}

                        {% if pinjam.current_fine > 0 %}
                            <div class="text-danger fw-black">
                                Rp{{ pinjam.current_fine|floatformat:0 }}
                                <span class="d-block x-small {% if pinjam.is_paid %}text-success{% else %}text-danger{% endif %}">
                                    {% if pinjam.is_paid %}(Lunas){% else %}(Belum Bayar){% endif %}
                                </span>
                            </div>
                        {% else %}
                            <span class="small text-muted fw-bold opacity-50">Rp0</span>
                        {% endif %}
                    </div>
                </div>

                <div class="col-12 col-lg-2 text-end">
                    {% if pinjam.status == 'pending' %}
                        <button class="btn btn-danger w-100 w-lg-auto rounded-pill px-4 fw-bold shadow-sm" 
                                onclick="openDeleteModal('{% url 'cancel_loan' pinjam.pk %}')"
                                style="font-size: 0.8rem;">
                            Batalkan
                        </button>
                    {% else %}
                        <span class="text-muted small fw-bold"><i class="bi bi-check2-all me-1"></i>Arsip</span>
                    {% endif %}
                </div>

            </div>
        </div>
        {% endfor %}
    </div>

    <div class="mt-5">
        {% include 'components/pagination.html' with halaman_buku=loans %}
    </div>

    {% else %}
    <div class="text-center py-5 border rounded-5 bg-white shadow-sm">
        <h5 class="text-muted fw-bold">Belum ada riwayat peminjaman.</h5>
        <a href="{% url 'book_list' %}" class="btn btn-success rounded-pill px-4 mt-3">Jelajahi Perpustakaan</a>
    </div>
    {% endif %}
</div>

<style>
    .filter-pill {
        display: inline-flex;
        align-items: center;
        padding: 8px 20px;
        border-radius: 100px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        color: #64748b;
        font-size: 13px;
        font-weight: 700;
        text-decoration: none;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .filter-pill:hover {
        background: #f1f5f9;
        color: #198754;
        border-color: #198754;
        transform: translateY(-2px);
    }

    .filter-pill.active {
        background: #198754;
        color: #ffffff;
        border-color: #198754;
        box-shadow: 0 10px 15px -3px rgba(25, 135, 84, 0.2);
    }
    .fw-black { font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 800; }
    .tracking-widest { letter-spacing: 0.2em; }
    .x-small { font-size: 0.6rem; }

    /* Baris Card Modern */
    .loan-row-card {
        background: #ffffff;
        border: 1px solid #edf2f7;
        border-radius: 20px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
    }

    .loan-row-card:hover {
        border-color: #198754;
        transform: scale(1.01);
        box-shadow: 0 10px 30px rgba(0, 78, 50, 0.05);
        z-index: 2;
    }

    .index-number {
        font-weight: 900;
        color: #e2e8f0;
        font-size: 1.5rem;
        line-height: 1;
    }

    /* Judul Buku Link */
    .book-title-link {
        transition: color 0.2s;
        line-height: 1.2;
        display: block;
    }
    .book-title-link:hover { color: #198754 !important; }

    /* Custom Badges */
    .badge-custom {
        padding: 6px 16px;
        border-radius: 100px;
        font-size: 0.7rem;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .badge-active { background: #e6fffa; color: #047481; border: 1px solid #b2f5ea; }
    .badge-pending { background: #fffaf0; color: #9c4221; border: 1px solid #feebc8; }
    .badge-rejected { background: #fff5f5; color: #9b2c2c; border: 1px solid #feb2b2; }

    /* Helper Borders di Desktop */
    @media (min-width: 992px) {
        .border-lg-start { border-left: 1px solid #edf2f7 !important; }
        .border-lg-end { border-right: 1px solid #edf2f7 !important; }
    }

    @media (max-width: 991px) {
        .loan-row-card { border-radius: 25px; }
        .index-number { margin-bottom: 10px; }
    }
</style>
{% endblock %}